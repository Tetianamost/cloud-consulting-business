# Requirements Document

## Introduction

The admin dashboard currently displays email monitoring metrics using mock data generated by the V0DataAdapter. This creates an inaccurate representation of actual email system performance and prevents administrators from making informed decisions about email delivery issues. This feature will replace the mock data with real email metrics collected from the actual email service operations.

## Requirements

### Requirement 1: Real Email Metrics Collection

**User Story:** As an administrator, I want to see actual email delivery metrics instead of mock data, so that I can monitor real email system performance and identify delivery issues.

#### Acceptance Criteria

1. WHEN the admin dashboard loads THEN the system SHALL display real email metrics from actual email service operations
2. WHEN an email is sent through the email service THEN the system SHALL record the email event with status, timestamp, and recipient information
3. WHEN email delivery status changes THEN the system SHALL update the stored email status record
4. IF real email data is unavailable THEN the system SHALL display a clear indicator that data is unavailable rather than showing mock data

### Requirement 2: Email Event Tracking

**User Story:** As an administrator, I want to track individual email events (sent, delivered, failed, bounced), so that I can identify specific delivery issues and patterns.

#### Acceptance Criteria

1. WHEN an email is sent via SendCustomerConfirmation THEN the system SHALL record the email event with type "customer_confirmation"
2. WHEN an email is sent via SendReportEmail THEN the system SHALL record the email event with type "consultant_notification"  
3. WHEN an email is sent via SendInquiryNotification THEN the system SHALL record the email event with type "inquiry_notification"
4. WHEN an email delivery fails THEN the system SHALL record the failure reason and error details
5. WHEN an email bounces or is marked as spam THEN the system SHALL categorize the failure appropriately

### Requirement 3: Email Metrics API Enhancement

**User Story:** As a frontend developer, I want enhanced email metrics APIs that provide comprehensive email statistics, so that the dashboard can display accurate real-time data.

#### Acceptance Criteria

1. WHEN the frontend requests email metrics THEN the API SHALL return aggregated statistics from real email events
2. WHEN the frontend requests email status for an inquiry THEN the API SHALL return actual email delivery status from recorded events
3. WHEN the API calculates delivery rates THEN it SHALL use actual sent/delivered/failed counts from recorded events
4. WHEN the API provides time-range filtering THEN it SHALL filter email events by actual timestamps

### Requirement 4: Database Schema for Email Tracking

**User Story:** As a system administrator, I want email events to be persistently stored, so that historical email performance data is available for analysis and reporting.

#### Acceptance Criteria

1. WHEN the system starts THEN it SHALL create email_events table if it doesn't exist
2. WHEN an email event is recorded THEN it SHALL be stored with inquiry_id, email_type, recipient, status, sent_at, delivered_at, error_message
3. WHEN email events are queried THEN the system SHALL support filtering by date range, status, and email type
4. WHEN the database reaches capacity THEN the system SHALL implement email event retention policies

### Requirement 5: SES Integration for Delivery Status

**User Story:** As an administrator, I want to receive actual delivery confirmations from AWS SES, so that email metrics reflect real delivery success/failure rates.

#### Acceptance Criteria

1. WHEN AWS SES delivers an email THEN the system SHALL update the email event status to "delivered"
2. WHEN AWS SES reports a bounce THEN the system SHALL update the email event status to "bounced" with bounce reason
3. WHEN AWS SES reports spam complaint THEN the system SHALL update the email event status to "spam" 
4. IF SES webhooks are not available THEN the system SHALL use SES API calls to check delivery status periodically

### Requirement 6: Dashboard Integration

**User Story:** As an administrator, I want the email monitoring dashboard to automatically use real data when available, so that I see accurate email performance without manual configuration.

#### Acceptance Criteria

1. WHEN the V0EmailDeliveryDashboardConnected component loads THEN it SHALL attempt to fetch real email metrics first
2. WHEN real email data is available THEN the dashboard SHALL display actual metrics without fallback to mock data
3. WHEN real email data is partially available THEN the dashboard SHALL display available real data and indicate missing data
4. WHEN the dashboard displays real data THEN it SHALL remove the "Using demo data" warning banner

### Requirement 7: Error Handling and Fallbacks

**User Story:** As an administrator, I want clear indicators when email monitoring data is unavailable, so that I understand the reliability of the displayed metrics.

#### Acceptance Criteria

1. WHEN email event recording fails THEN the system SHALL log the error but continue email delivery
2. WHEN email metrics API fails THEN the frontend SHALL display an error message instead of mock data
3. WHEN partial email data is available THEN the dashboard SHALL display available data with appropriate disclaimers
4. WHEN email tracking is disabled THEN the system SHALL clearly indicate that monitoring is not active